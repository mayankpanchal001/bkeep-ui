name: Deploy Docker Image

on:
    workflow_run:
        workflows: ['Build and Push Docker Image']
        types:
            - completed
        branches:
            - main
            - master
    workflow_dispatch:
        inputs:
            image_tag:
                description: 'Docker image tag to deploy'
                required: true
                default: 'latest'

jobs:
    deploy:
        name: Deploy to Server
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set image tag
              id: tag
              run: |
                  if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
                      echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
                  else
                      echo "tag=latest" >> $GITHUB_OUTPUT
                  fi

            - name: Deploy to server via SSH
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.DEPLOY_HOST }}
                  username: ${{ secrets.DEPLOY_USER }}
                  key: ${{ secrets.DEPLOY_SSH_KEY }}
                  port: ${{ secrets.DEPLOY_PORT || 22 }}
                  script: |
                      # Login to GitHub Container Registry
                      echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

                      # Pull the latest image
                      docker pull ghcr.io/${{ github.repository }}:${{ steps.tag.outputs.tag }}

                      # Stop and remove old container
                      docker stop bkeep-frontend || true
                      docker rm bkeep-frontend || true

                      # Run new container
                      docker run -d \
                        --name bkeep-frontend \
                        --restart unless-stopped \
                        -p 80:80 \
                        ghcr.io/${{ github.repository }}:${{ steps.tag.outputs.tag }}

                      # Clean up old images
                      docker image prune -f

            - name: Deployment summary
              run: |
                  echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Status:** âœ… Deployed successfully" >> $GITHUB_STEP_SUMMARY
                  echo "**Image:** \`ghcr.io/${{ github.repository }}:${{ steps.tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "**Server:** ${{ secrets.DEPLOY_HOST }}" >> $GITHUB_STEP_SUMMARY
