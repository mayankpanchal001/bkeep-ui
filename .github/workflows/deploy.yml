name: Deploy to VPS

on:
    push:
        branches:
            - main

env:
    DOCKER_USERNAME: mayankpanchal0001
    IMAGE_NAME: bkeep-frontend
    VPS_IP: 150.241.247.80
    VPS_DOMAIN: finanza.ca
    CONTAINER_NAME: bkeep-frontend
    VPS_USERNAME: root

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Generate build metadata
              id: metadata
              run: |
                  echo "build_date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
                  echo "git_commit=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
                  echo "git_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

            - name: Log in to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ env.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_PASSWORD }}

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./Dockerfile
                  platforms: linux/amd64
                  push: true
                  tags: |
                      ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
                      ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.metadata.outputs.git_commit }}
                  build-args: |
                      VITE_API_ENDPOINT=${{ vars.VITE_API_ENDPOINT || format('http://{0}:4000/api/v1', env.VPS_DOMAIN) }}
                      VITE_ENVIRONMENT=production
                      VITE_BUILD_DATE=${{ steps.metadata.outputs.build_date }}
                      VITE_GIT_COMMIT=${{ steps.metadata.outputs.git_commit }}
                  cache-from: type=registry,ref=${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:buildcache
                  cache-to: type=registry,ref=${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

            - name: Deploy to VPS
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ env.VPS_IP }}
                  username: ${{ secrets.VPS_USERNAME || env.VPS_USERNAME }}
                  password: ${{ secrets.VPS_SSH_PASSWORD }}
                  port: ${{ secrets.VPS_SSH_PORT || 22 }}
                  timeout: 30s
                  script: |
                      set -e

                      echo "ðŸš€ Starting deployment..."

                      # Navigate to project directory (adjust path if needed)
                      PROJECT_DIR="${PROJECT_DIR:-/root/bkeep-frontend}"
                      if [ ! -d "$PROJECT_DIR" ]; then
                          PROJECT_DIR="."
                      fi
                      cd "$PROJECT_DIR" || cd ~ || cd /

                      # Login to Docker Hub
                      echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ env.DOCKER_USERNAME }}" --password-stdin || true

                      # Pull latest image
                      echo "ðŸ“¥ Pulling latest image..."
                      docker pull ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest

                      # Deploy using docker run (matches vps-build.sh update command)
                      echo "ðŸ³ Deploying container..."

                      # Stop and remove existing container
                      docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null || true
                      docker rm ${{ env.CONTAINER_NAME }} 2>/dev/null || true

                      # Run new container with same configuration as docker-compose
                      docker run -d \
                          --name ${{ env.CONTAINER_NAME }} \
                          -p 80:80 \
                          --restart unless-stopped \
                          ${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest

                      # Wait for container to start
                      echo "â³ Waiting for container to start..."
                      sleep 5

                      # Check container status
                      echo "ðŸ“Š Container status:"
                      docker ps --filter "name=${{ env.CONTAINER_NAME }}" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

                      # Health check
                      echo "ðŸ¥ Performing health check..."
                      sleep 3
                      MAX_RETRIES=5
                      RETRY_COUNT=0
                      HEALTH_CHECK_PASSED=false

                      while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                          if curl -f http://localhost/health > /dev/null 2>&1; then
                              echo "âœ… Health check passed!"
                              HEALTH_CHECK_PASSED=true
                              break
                          else
                              RETRY_COUNT=$((RETRY_COUNT + 1))
                              echo "â³ Health check attempt $RETRY_COUNT/$MAX_RETRIES..."
                              sleep 3
                          fi
                      done

                      if [ "$HEALTH_CHECK_PASSED" = false ]; then
                          echo "âš ï¸  Health check did not pass after $MAX_RETRIES attempts"
                          echo "ðŸ“‹ Container logs:"
                          docker logs --tail=50 ${{ env.CONTAINER_NAME }} || true
                      fi

                      # Clean up old images (keep last 2 versions)
                      echo "ðŸ§¹ Cleaning up old Docker images..."
                      docker image prune -f || true

                      # Remove dangling images
                      docker images --filter "dangling=true" -q | xargs -r docker rmi || true

                      echo "âœ… Deployment completed successfully!"
                      echo "ðŸŒ Application available at: http://${{ env.VPS_IP }}"

            - name: Deployment Summary
              run: |
                  echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
                  echo "**Image:** \`${{ env.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.metadata.outputs.git_commit }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "**Build Date:** ${{ steps.metadata.outputs.build_date }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Git Commit:** \`${{ steps.metadata.outputs.git_commit }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "**VPS:** ${{ env.VPS_IP }}" >> $GITHUB_STEP_SUMMARY
                  echo "**URL:** http://${{ env.VPS_IP }}" >> $GITHUB_STEP_SUMMARY
